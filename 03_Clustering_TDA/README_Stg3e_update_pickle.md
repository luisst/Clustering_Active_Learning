# Stg3e_update_pickle_with_human_labels.py

## Overview

This script updates the `merged_clustering_data.pickle` file generated by [Stg3d_merge_wavs.py](Stg3d_merge_wavs.py) with human-labeled ground truth data from the Active Learning webapp results.

## Purpose

After running the Active Learning webapp and obtaining human labels for speaker diarization, this script:
1. Reads the CSV files with human labels from the `webapp_results` folder
2. Matches them to the merged audio samples based on time overlap
3. Updates the pickle file with a new column containing the human-labeled speaker IDs

## Input Files

### Required Inputs

1. **Pickle File**: `merged_clustering_data.pickle`
   - Location: `{DATASET}/STG_3/{STG3_METHOD}/merged_clustering_data.pickle`
   - Generated by: [Stg3d_merge_wavs.py](Stg3d_merge_wavs.py)
   - Contains 8 elements: features, paths, embeddings, t-SNE, GT labels, cluster labels, probabilities, outlier scores

2. **Mapping JSON**: `merged_files_mapping.json`
   - Location: `{DATASET}/STG_3/{STG3_METHOD}/merged_files_mapping.json`
   - Generated by: [Stg3d_merge_wavs.py](Stg3d_merge_wavs.py)
   - Maps sample indices to their metadata (start_time, end_time, etc.)

3. **Human Labels CSV**: Tab-separated CSV files
   - Location: `{DATASET}/STG_4/STG4_{LP_METHOD}/webapp_results/*.csv`
   - Format:
     ```
     SampleIndex	SpeakerLP	StartTime	EndTime	ClusterPred
     101	S0	7.60	9.50	1
     7	S1	54.11	55.05	2
     ```

## Output Files

### Primary Output

1. **Updated Pickle File**: `merged_clustering_data_with_labels.pickle`
   - Location: `{DATASET}/STG_4/STG4_{LP_METHOD}/updated_pickle_data/`
   - Contains 9 elements (original 8 + new speaker_lp column)
   - New element (index 8): numpy array of speaker labels (None for unlabeled samples)

### Secondary Outputs

2. **Matching Report**: `human_labels_matching_report.csv`
   - Location: `{DATASET}/STG_4/STG4_{LP_METHOD}/updated_pickle_data/`
   - Contains detailed information about each matched sample
   - Columns: SampleIndex, SpeakerLP, HumanStartTime, HumanEndTime, MergedStartTime, MergedEndTime, OverlapPercent, ClusterPred, Filename

## Usage

### Basic Usage

```bash
python Stg3e_update_pickle_with_human_labels.py \
    --dataset_name TestAO-Irma \
    --lp_method LP1 \
    --stg3_method STG3_EXP010-SHAS-DV-hdb
```

### Advanced Options

```bash
python Stg3e_update_pickle_with_human_labels.py \
    --dataset_name TestAO-Irma \
    --lp_method LP1 \
    --stg3_method STG3_EXP010-SHAS-DV-hdb \
    --overlap_threshold 90.0 \
    --output_suffix _with_labels
```

### Command-Line Arguments

| Argument | Type | Default | Description |
|----------|------|---------|-------------|
| `--dataset_name` | str | `TestAO-Irma` | Dataset name in the Unsupervised_Pipeline folder |
| `--lp_method` | str | `LP1` | Label propagation method name (e.g., LP1, LP2) |
| `--stg3_method` | str | `STG3_EXP010-SHAS-DV-hdb` | Stage 3 clustering method name |
| `--overlap_threshold` | float | `90.0` | Minimum overlap percentage for matching (0-100) |
| `--output_suffix` | str | `_with_labels` | Suffix for output pickle filename |

## Matching Algorithm

### Time Overlap Calculation

The script matches human labels to merged samples based on time overlap:

1. **Overlap Percentage** = (Overlap Duration / Original Sample Duration) × 100
2. Samples are matched only if overlap ≥ `overlap_threshold` (default: 90%)

### Example

```
Merged Sample:    [10.0s =================== 15.0s]  (5.0s duration)
Human Label:      [10.5s =============== 14.5s]      (4.0s duration)
Overlap:          [10.5s =========== 14.5s]          (4.0s overlap)
Overlap %:        (4.0 / 5.0) × 100 = 80%

Result: Not matched (80% < 90% threshold)
```

### Special Cases

1. **Exact Match**: When human label times exactly match merged sample times (100% overlap)
2. **Adjusted Times**: When human corrected the start/end times (overlap ≥ threshold)
3. **Split Samples**: Not currently handled - requires manual CSV editing to match indices

## Output Structure

### Updated Pickle Structure

The updated pickle file contains **9 elements** (original had 8):

```python
# Load the updated pickle
with open('merged_clustering_data_with_labels.pickle', 'rb') as f:
    data = pickle.load(f)

# Unpack all 9 elements
merged_x_data,          # [0] (N, D) - D-vector features
merged_paths,           # [1] N items - WAV file stems
merged_hdb_data,        # [2] (N, D) - HDBSCAN embeddings
merged_tsne_2d,         # [3] (N, 2) - t-SNE coordinates
merged_y_labels,        # [4] (N,) - Ground truth labels
merged_sample_labels,   # [5] (N,) - HDBSCAN cluster assignments
merged_sample_probs,    # [6] (N,) - HDBSCAN probabilities
merged_sample_outliers, # [7] (N,) - Outlier scores
speaker_lp_column = data  # [8] (N,) - Human-labeled speakers (NEW!)

# Access speaker labels
for i, speaker in enumerate(speaker_lp_column):
    if speaker is not None:
        print(f"Sample {i}: {merged_paths[i]} -> Speaker: {speaker}")
    else:
        print(f"Sample {i}: {merged_paths[i]} -> No human label")
```

### Speaker Label Column (Element 8)

- **Type**: `numpy.ndarray` with `dtype=object`
- **Shape**: `(N,)` where N = number of samples
- **Values**:
  - `'S0'`, `'S1'`, `'S2'`, etc. for labeled samples
  - `None` for unlabeled samples

## Handling Edge Cases

### 1. Multiple CSV Files

The script automatically reads and merges **all CSV files** in the `webapp_results` folder.

### 2. Duplicate Sample Indices

If the same `SampleIndex` appears in multiple CSV files, the **last occurrence** is used (based on file processing order).

### 3. Low Overlap

Samples with overlap below the threshold are **not matched** and receive `None` in the speaker_lp column. A warning is printed:

```
Warning: SampleIndex 42 overlap too low (75.3% < 90.0%)
```

### 4. Missing Sample Indices

If a `SampleIndex` from the CSV is not found in the mapping JSON, a warning is printed:

```
Warning: SampleIndex 999 not found in merged data mapping
```

### 5. Split Samples

If you manually split a sample in the webapp (creating 2 new samples from 1), you need to:
1. Manually assign new `SampleIndex` values in the CSV
2. Ensure the indices correspond to samples in the pickle file
3. The script will match based on time overlap

**Note**: Automatic sample splitting/appending is not currently supported and would require modifying the pickle structure.

## Numpy Version Compatibility

The script includes automatic handling for numpy version differences between 1.x and 2.x:

- **Numpy 2.x**: Uses `numpy._core` module structure
- **Numpy 1.x**: Uses `numpy.core` module structure
- **Pickle Files**: May have been created with either version

The script automatically detects and handles both formats.

## Integration with Downstream Scripts

### Using the Updated Pickle in Label Propagation

To use the updated pickle file in [stg4d_LP.py](../04_Active_learning_loop/stg4d_LP.py):

```python
# Load the updated pickle with human labels
with open('merged_clustering_data_with_labels.pickle', 'rb') as f:
    merged_clustering_data = pickle.load(f)

# Unpack including the new speaker_lp column
merged_X_data, \
merged_paths, \
merged_hdb_data, \
merged_tsne_2d, \
merged_y_labels, \
merged_sample_labels, \
merged_sample_probs, \
merged_sample_outliers, \
speaker_lp_column = merged_clustering_data  # NEW: 9th element

# Use speaker_lp for label propagation initialization
for idx, speaker in enumerate(speaker_lp_column):
    if speaker is not None:
        # This sample has a human label
        human_labels[idx] = speaker
```

## Example Workflow

### Complete Pipeline

1. **Stage 3**: Run [Stg3d_merge_wavs.py](Stg3d_merge_wavs.py) to create merged audio segments
   ```bash
   python Stg3d_merge_wavs.py --exp_name TTS4_easy
   ```
   - Output: `merged_clustering_data.pickle` (8 elements)

2. **Stage 4**: Run Active Learning webapp for human labeling
   - Output: `webapp_results/*.csv` with human labels

3. **Stage 3e** (this script): Update pickle with human labels
   ```bash
   python Stg3e_update_pickle_with_human_labels.py \
       --dataset_name TTS4_easy \
       --lp_method LP1
   ```
   - Output: `merged_clustering_data_with_labels.pickle` (9 elements)

4. **Stage 4d**: Run label propagation with updated pickle
   ```bash
   python stg4d_LP.py
   ```

## Testing

### Verify the Output

```bash
python -c "
import pickle
import sys
import numpy as np

# Load compatibility
try:
    import numpy._core as numpy_core
    sys.modules['numpy.core'] = numpy_core
except: pass

# Load pickle
with open('path/to/merged_clustering_data_with_labels.pickle', 'rb') as f:
    data = pickle.load(f)

print(f'Elements: {len(data)}')
print(f'Samples: {len(data[1])}')
print(f'Labeled: {sum(1 for x in data[8] if x is not None)}')
print(f'Unlabeled: {sum(1 for x in data[8] if x is None)}')
"
```

### Expected Output

```
Elements: 9
Samples: 120
Labeled: 9
Unlabeled: 111
```

## Troubleshooting

### Error: "No module named 'numpy._core'"

**Solution**: The script includes automatic numpy compatibility handling. If this error occurs, try:
```bash
pip install --upgrade numpy
```

### Error: "Folder 'webapp_results' does not exist"

**Solution**: Ensure you've run the Active Learning webapp and saved the human labels to the correct folder.

### Warning: "SampleIndex X overlap too low"

**Solution**: This means the human-labeled time range doesn't overlap enough with the merged sample. Options:
1. Lower the `--overlap_threshold` parameter (e.g., `--overlap_threshold 80.0`)
2. Check if the CSV file has incorrect times
3. Verify the `SampleIndex` is correct

### No matches found

**Solution**: Check that:
1. The `SampleIndex` values in the CSV correspond to `merged_idx` in the JSON mapping
2. The CSV file format is correct (tab-separated)
3. The CSV files are in the correct folder

## Performance

- **Speed**: Processes ~1000 samples in <5 seconds
- **Memory**: Requires enough RAM to load the entire pickle file (typically <500MB)
- **Disk**: Output pickle file is approximately the same size as input

## Related Files

- [Stg3d_merge_wavs.py](Stg3d_merge_wavs.py) - Creates the input pickle file
- [stg4d_LP.py](../04_Active_learning_loop/stg4d_LP.py) - Uses the output pickle for label propagation
- [Stg3Extra_interactiveGTclusters.py](Stg3Extra_interactiveGTclusters.py) - Interactive visualization

## Author

Created: 2025-01-01
Version: 1.0
